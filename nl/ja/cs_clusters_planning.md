---

copyright:
  years: 2014, 2019
lastupdated: "2019-06-12"

keywords: kubernetes, iks, multi az, multi-az, szr, mzr

subcollection: containers

---

{:new_window: target="_blank"}
{:shortdesc: .shortdesc}
{:screen: .screen}
{:pre: .pre}
{:table: .aria-labeledby="caption"}
{:codeblock: .codeblock}
{:tip: .tip}
{:note: .note}
{:important: .important}
{:deprecated: .deprecated}
{:download: .download}
{:preview: .preview}


# クラスター・ネットワークのセットアップの計画
{: #plan_clusters}

ワークロードおよび環境のニーズを満たす {{site.data.keyword.containerlong}} クラスターのネットワークのセットアップを設計します。
{: shortdesc}

{{site.data.keyword.containerlong_notm}} クラスターでは、コンテナー化アプリは、ワーカー・ノードと呼ばれるコンピュート・ホスト上でホストされます。ワーカー・ノードは Kubernetes マスターによって管理されます。 ワーカー・ノードと Kubernetes マスター、他のサービス、インターネット、またはその他のプライベート・ネットワークとの間の通信セットアップは、IBM Cloud インフラストラクチャー (SoftLayer) ネットワークのセットアップ方法によって異なります。

初めてクラスターを作成する場合は、最初に[チュートリアル](/docs/containers?topic=containers-cs_cluster_tutorial)を試し、実動用クラスターを計画する準備ができたら、ここに戻ってください。
{: tip}

クラスター・ネットワークのセットアップを計画するには、まず[クラスター・ネットワークの基本を理解](#plan_basics)します。その後、[インターネット向けアプリ・ワークロードの実行](#internet-facing)、[限定パブリック・アクセスを使用したオンプレミス・データ・センターの拡張](#limited-public)、[プライベート・ネットワークのみでのオンプレミス・データ・センターの拡張](#private_clusters)など、環境ベースのシナリオに適した 3 つの潜在的なクラスター・ネットワークのセットアップを確認できます。

## クラスター・ネットワークの基本について
{: #plan_basics}

クラスターを作成するときには、特定のクラスター・コンポーネントがお互いに通信し、クラスター外部のネットワークまたはサービスと通信できるように、ネットワークのセットアップを選択する必要があります。
{: shortdesc}

* [ワーカー間通信](#worker-worker): すべてのワーカー・ノードがプライベート・ネットワークで相互に通信できる必要があります。多くの場合、複数のプライベート VLAN 間で通信を許可して、異なる VLAN および異なるゾーンのワーカーが相互に接続できるようにする必要があります。
* [ワーカーとマスターおよびユーザーとマスターの間の通信](#workeruser-master): ワーカー・ノードと許可されたクラスター・ユーザーは、TLS を使用するパブリック・ネットワークまたはプライベート・サービス・エンドポイントを介するプライベート・ネットワーク経由で Kubernetes マスターと安全に通信できます。
* [他の {{site.data.keyword.Bluemix_notm}} サービスまたはオンプレミス・ネットワークへのワーカー通信](#worker-services-onprem): ワーカー・ノードが他の {{site.data.keyword.Bluemix_notm}} サービス ({{site.data.keyword.registrylong}} など) およびオンプレミス・ネットワークと安全に通信できるようにします。
* [ワーカー・ノードで実行されるアプリへの外部通信](#external-workers): クラスターへのパブリック要求またはプライベート要求と、パブリック・エンドポイントへのクラスターからの要求を許可します。

### ワーカー間通信
{: #worker-worker}

クラスターを作成すると、クラスターの各ワーカー・ノードが 1 つのプライベート VLAN に自動的に接続され、オプションでパブリック VLAN に接続されます。VLAN では、ワーカー・ノードをまとめた 1 つのグループを、それらのワーカー・ノードとポッドが同じ物理ワイヤーに接続されているかのように構成し、それらのワーカーとポッド間の接続に 1 つのチャネルを提供します。
{: shortdesc}

**ワーカー・ノードの VLAN 接続**</br>
各ワーカー・ノードが他のワーカー・ノードと情報を送受信できるように、すべてのワーカー・ノードをプライベート VLAN に接続する必要があります。パブリック VLAN にも接続されているワーカー・ノードを含むクラスターを作成する場合、プライベート・サービス・エンドポイントを有効にすると、ワーカー・ノードはパブリック VLAN およびプライベート VLAN を介して Kubernetes マスターと自動的に通信できます。パブリック VLAN はパブリック・ネットワーク接続も提供するため、クラスター内のアプリをインターネットに公開できます。ただし、パブリック・インターフェースからアプリを保護する必要がある場合は、Calico ネットワーク・ポリシーの使用やエッジ・ワーカー・ノードへの外部ネットワーク・ワークロードの分離など、クラスターを保護するためのいくつかのオプションを使用できます。
* フリー・クラスター: フリー・クラスターでは、クラスターのワーカー・ノードは、IBM 所有のパブリック VLAN とプライベート VLAN にデフォルトで接続されます。IBM が VLAN、サブネット、および IP アドレスを制御するので、ユーザーは複数ゾーン・クラスターを作成することも、クラスターにサブネットを追加することもできません。また、アプリを公開するには NodePort サービスだけを使用できます。</dd>
* 標準クラスター: 標準クラスターでは、あるゾーンで初めてクラスターを作成したときに、そのゾーン内のパブリック VLAN とプライベート VLAN が IBM Cloud インフラストラクチャー (SoftLayer) アカウントで自動的にプロビジョンされます。ワーカー・ノードをプライベート VLAN にのみ接続するように指定した場合、そのゾーン内のプライベート VLAN のみが自動的にプロビジョンされます。それ以降、そのゾーンにクラスターを作成するたびに、使用する VLAN のペアを指定できます。VLAN は複数のクラスターで共有できるので、お客様用に作成された同一のパブリック VLAN とプライベート VLAN を何度も使用することができます。

VLAN、サブネット、および IP アドレスについて詳しくは、[{{site.data.keyword.containerlong_notm}} でのネットワーキングの概要](/docs/containers?topic=containers-subnets#basics)を参照してください。

**サブネットおよび VLAN 間のワーカー・ノード通信**</br>
状況によっては、クラスターのコンポーネントに複数のプライベート VLAN をまたぐ通信を許可しなければならない場合があります。例えば、複数ゾーン・クラスターを作成する場合や、1 つのクラスターに複数の VLAN が存在する場合、同じ VLAN 上に複数のサブネットが存在する場合は、同じ VLAN 上にあってもサブネットが異なるワーカー・ノード、または異なる VLAN 上にあるワーカー・ノードは、そのままでは相互通信することができません。 ユーザーが IBM Cloud インフラストラクチャー (SoftLayer) アカウントで Virtual Routing and Forwarding (VRF) または VLAN スパンニングを有効にする必要があります。

* [Virtual Routing and Forwarding (VRF)](/docs/infrastructure/direct-link?topic=direct-link-overview-of-virtual-routing-and-forwarding-vrf-on-ibm-cloud#overview-of-virtual-routing-and-forwarding-vrf-on-ibm-cloud): VRF は、インフラストラクチャー・アカウント内のすべてのプライベート VLAN およびサブネットが相互に通信できるようにします。さらに、ワーカーとマスターがプライベート・サービス・エンドポイントを介して通信し、プライベート・サービス・エンドポイントをサポートする他の {{site.data.keyword.Bluemix_notm}} インスタンスと通信できるようにするには、VRF が必要です。VRF を有効にするには、`ibmcloud account update --service-endpoint-enable true` を実行します。このコマンド出力によって、アカウントで VRF およびサービス・エンドポイントを使用できるようにするためのサポート・ケースを開くように求めるプロンプトが出されます。VRF を有効にする場合は、アカウントの VLAN スパンニングは不要になります。これは、すべての VLAN が通信できるようになるためです。</br></br>
VRF を有効にすると、同じ {{site.data.keyword.Bluemix_notm}} アカウントのプライベート VLAN に接続されているすべてのシステムが、クラスター・ワーカー・ノードと通信できるようになります。[Calico プライベート・ネットワーク・ポリシー](/docs/containers?topic=containers-network_policies#isolate_workers)を適用すれば、クラスターをプライベート・ネットワーク上の他のシステムから切り離せます。</dd>
* [VLAN スパンニング](/docs/infrastructure/vlans?topic=vlans-vlan-spanning#vlan-spanning): プライベート・ネットワーク上でマスターにアクセスする必要がない場合や、ゲートウェイ・デバイスを使用してパブリック VLAN を介してマスターにアクセスする場合など、VRF を有効にできないか、有効にしない場合は、VLAN スパンニングを有効にします。例えば、既存のゲートウェイ・デバイスがある場合にクラスターを追加すると、クラスター用に注文した新しいポータブル・サブネットは、ゲートウェイ・デバイス上に構成されず、VLAN スパンニングによってサブネット間の経路指定が有効になります。VLAN スパンニングを有効にするには、**「ネットワーク」>「ネットワーク VLAN スパンニングの管理」**で設定する[インフラストラクチャー権限](/docs/containers?topic=containers-users#infra_access)が必要です。ない場合は、アカウント所有者に対応を依頼してください。VLAN スパンニングが既に有効になっているかどうかを確認するには、`ibmcloud ks vlan-spanning-get` [コマンド](/docs/containers?topic=containers-cli-plugin-kubernetes-service-cli#cs_vlan_spanning_get)を使用します。 VRF の代わりに VLAN スパンニングを有効にすることを選択した場合は、プライベート・サービス・エンドポイントを有効にできません。

</br>

### ワーカーとマスターおよびユーザーとマスターの間の通信
{: #workeruser-master}

ワーカー・ノードが Kubernetes マスターへの接続を確立できるように、通信チャネルをセットアップする必要があります。ワーカー・ノードと Kubernetes マスターが通信できるようにするには、パブリック・サービス・エンドポイントのみ、パブリック・サービス・エンドポイントとプライベート・サービス・エンドポイント、またはプライベート・サービス・エンドポイントのみを有効にします。
{: shortdesc}

パブリック・サービス・エンドポイントおよびプライベート・サービス・エンドポイントを介した通信を保護するために、{{site.data.keyword.containerlong_notm}} は、クラスターの作成時に、Kubernetes マスターとワーカー・ノードの間の OpenVPN 接続を自動的にセットアップします。ワーカーは TLS 証明書を使用してマスターに安全にアクセスし、マスターは OpenVPN 接続を使用してワーカーにアクセスします。

**パブリック・サービス・エンドポイントのみ**</br>
アカウントの VRF を有効にしない、または有効にできない場合、ワーカー・ノードはパブリック・サービス・エンドポイントを介してパブリック VLAN 経由で自動的に Kubernetes マスターに接続できます。
* ワーカー・ノードとマスターの通信は、パブリック・サービス・エンドポイントを介してパブリック・ネットワーク経由で安全に確立されます。
* 許可されたクラスター・ユーザーのみが、パブリック・サービス・エンドポイントを介してパブリックからマスターにアクセスできます。クラスター・ユーザーはインターネット経由で Kubernetes マスターに安全にアクセスし、例えば `kubectl` コマンドを実行したりできます。

**パブリック・サービス・エンドポイントおよびプライベート・サービス・エンドポイント**</br>
パブリックからでもプライベートからでもクラスター・ユーザーが利用できるマスターにするには、パブリック・サービス・エンドポイントおよびプライベート・サービス・エンドポイントを有効にします。{{site.data.keyword.Bluemix_notm}} アカウントに VRF が必要です。また、アカウントでサービス・エンドポイントを使用できるようにする必要があります。VRF およびサービス・エンドポイントを有効にするには、`ibmcloud account update --service-endpoint-enable true` を実行します。
* ワーカー・ノードがパブリック VLAN とプライベート VLAN に接続されている場合、ワーカー・ノードとマスターの通信は、プライベート・サービス・エンドポイントを介するプライベート・ネットワークと、パブリック・サービス・エンドポイントを介したパブリック・ネットワークの両方を経由して確立されます。ワーカーからマスターへのトラフィックをパブリック・エンドポイントとプライベート・エンドポイントに半分ずつルーティングすると、マスターからワーカーへの通信が、パブリック・ネットワークまたはプライベート・ネットワークの可能性のある障害から保護されます。 ワーカー・ノードがプライベート VLAN のみに接続されている場合、ワーカー・ノードとマスターの通信は、プライベート・サービス・エンドポイントを介したプライベート・ネットワーク経由のみで確立されます。
* 許可されたクラスター・ユーザーは、パブリック・サービス・エンドポイントを介してパブリックからマスターにアクセスできます。 許可されたクラスター・ユーザーは、{{site.data.keyword.Bluemix_notm}} プライベート・ネットワークの中で作業している場合、または VPN 接続または {{site.data.keyword.Bluemix_notm}} Direct Link 経由でプライベート・ネットワークに接続している場合に、プライベート・サービス・エンドポイントを介して、プライベートにマスターにアクセスできます。ユーザーが VPN 接続または {{site.data.keyword.Bluemix_notm}} Direct Link 接続を介してマスターにアクセスできるように、[プライベート・ロード・バランサーを介してマスター・エンドポイントを公開](/docs/containers?topic=containers-clusters#access_on_prem)する必要があります。

**プライベート・サービス・エンドポイントのみ**</br>
マスターにプライベートでのみアクセスできるようにするには、プライベート・サービス・エンドポイントを有効にします。{{site.data.keyword.Bluemix_notm}} アカウントに VRF が必要です。また、アカウントでサービス・エンドポイントを使用できるようにする必要があります。VRF およびサービス・エンドポイントを有効にするには、`ibmcloud account update --service-endpoint-enable true` を実行します。 プライベート・サービス・エンドポイントを使用すると、請求された帯域幅または従量制帯域幅の課金は発生しません。
* ワーカー・ノードとマスターの通信は、プライベート・サービス・エンドポイントを介してプライベート・ネットワーク経由で安全に確立されます。
* 許可されたクラスター・ユーザーは、{{site.data.keyword.Bluemix_notm}} プライベート・ネットワークの中で作業している場合、または VPN 接続または DirectLink 経由でプライベート・ネットワークに接続している場合に、プライベートにマスターにアクセスできます。ユーザーが VPN 接続または DirectLink 接続を介してマスターにアクセスできるように、[プライベート・ロード・バランサーを介してマスター・エンドポイントを公開](/docs/containers?topic=containers-clusters#access_on_prem)する必要があります。

</br>

### 他の {{site.data.keyword.Bluemix_notm}} サービスまたはオンプレミス・ネットワークへのワーカー通信
{: #worker-services-onprem}

ワーカー・ノードが他の {{site.data.keyword.Bluemix_notm}} サービス ({{site.data.keyword.registrylong}} など) およびオンプレミス・ネットワークと安全に通信できるようにします。
{: shortdesc}

**プライベート・ネットワークまたはパブリック・ネットワークを介した他の {{site.data.keyword.Bluemix_notm}} サービスとの通信**</br>
ワーカー・ノードは、IBM Cloud インフラストラクチャー (SoftLayer) プライベート・ネットワークを介して、{{site.data.keyword.registrylong}} など、プライベート・サービス・エンドポイントをサポートする他の {{site.data.keyword.Bluemix_notm}} サービスと自動的かつ安全に通信できます。{{site.data.keyword.Bluemix_notm}} サービスがプライベート・サービス・エンドポイントをサポートしていない場合は、パブリック・ネットワークを介してサービスと安全に通信できるように、ワーカー・ノードをパブリック VLAN に接続する必要があります。

Calico ネットワーク・ポリシーを使用してクラスター内のパブリック・ネットワークをロックダウンする場合、Calico ポリシーで使用するサービスのパブリック IP アドレスおよびプライベート IP アドレスへのアクセスを許可する必要がある場合があります。Virtual Router Appliance (Vyatta) などのゲートウェイ・デバイスを使用する場合は、ゲートウェイ・デバイス・ファイアウォールで[使用するサービスのプライベート IP アドレスへのアクセスを許可する](/docs/containers?topic=containers-firewall#firewall_outbound)必要があります。
{: note}

**プライベート・ネットワークを介したオンプレミス・データ・センターのリソースとの通信用 {{site.data.keyword.BluDirectLink}}**</br>
クラスターをオンプレミス・データ・センター ({{site.data.keyword.icpfull_notm}} など) に接続するには、[{{site.data.keyword.Bluemix_notm}} Direct Link](/docs/infrastructure/direct-link?topic=direct-link-get-started-with-ibm-cloud-direct-link) をセットアップします。{{site.data.keyword.Bluemix_notm}} Direct Link を使用して、パブリック・インターネット経由で経路指定せずに、リモート・ネットワーク環境と {{site.data.keyword.containerlong_notm}} の間の直接のプライベート接続を作成します。

**パブリック・ネットワークを介したオンプレミス・データ・センターのリソースとの通信のための strongSwan IPSec VPN 接続**
* パブリック VLAN およびプライベート VLAN に接続されているワーカー・ノード: [strongSwan IPSec VPN サービス ![外部リンク・アイコン](../icons/launch-glyph.svg "外部リンク・アイコン")](https://www.strongswan.org/about.html) をクラスター内に直接セットアップします。strongSwan IPSec VPN サービスは、業界標準の Internet Protocol Security (IPSec) プロトコル・スイートに基づき、インターネット上にセキュアなエンドツーエンドの通信チャネルを確立します。 クラスターとオンプレミス・ネットワークの間にセキュアな接続をセットアップするためには、クラスター内のポッドに直接、[strongSwan IPSec VPN サービスを構成してデプロイします](/docs/containers?topic=containers-vpn#vpn-setup)。
* プライベート VLAN のみに接続されたワーカー・ノード: Virtual Router Appliance (Vyatta) などのゲートウェイ・デバイスで IPSec VPN エンドポイントをセットアップします。次に、クラスターに [strongSwan IPSec VPN サービスを構成して](/docs/containers?topic=containers-vpn#vpn-setup)、ゲートウェイの VPN エンドポイントを使用します。strongSwan を使用しない場合は、[VRA を使用して、直接、VPN 接続をセットアップ](/docs/containers?topic=containers-vpn#vyatta)できます。

</br>

### ワーカー・ノードで実行されるアプリへの外部通信
{: #external-workers}

クラスター外部からワーカー・ノードで実行されるアプリへのパブリック・トラフィック要求またはプライベート・トラフィック要求を許可します。
{: shortdesc}

**クラスター・アプリへのプライベート・トラフィック**</br>
クラスター内でアプリをデプロイする場合、クラスターと同じプライベート・ネットワークのユーザーおよびサービスのみがアプリにアクセスできるようにすることもできます。プライベート・ロード・バランシングは、アプリを一般的に公開することなく、クラスター外からの要求で使用できるようにする場合に理想的です。 プライベート・ロード・バランシングを使用して、アプリのアクセス、要求ルーティング、およびその他の構成をテストしてから、後でパブリック・ネットワーク・サービスを使用してアプリをパブリックに公開することもできます。 クラスターの外部からのアプリへのプライベート・トラフィック要求を許可するには、プライベート NodePort、NLB、Ingress ALB などのプライベート Kubernetes ネットワーク・サービスを作成します。その後、Calico pre-DNAT ポリシーを使用して、プライベート・ネットワーク・サービスのパブリック NodePort へのトラフィックをブロックできます。詳しくは、[プライベート外部ロード・バランシングの計画](/docs/containers?topic=containers-cs_network_planning#private_access)を参照してください。

**クラスター・アプリへのパブリック・トラフィック**</br>
パブリック・インターネットからアプリへの外部アクセスを可能にするには、パブリック NodePort、ネットワーク・ロード・バランサー (NLB)、および Ingress アプリケーション・ロード・バランサー (ALB) を作成します。パブリック IP アドレスおよびオプションでパブリック URL を使用してアプリを提供すると、パブリック・ネットワーク・サービスがそのパブリック・ネットワーク・インターフェースに接続します。 アプリがパブリックに公開されると、アプリに対してセットアップしたパブリック・サービスの IP アドレスまたは URL を持つユーザーはアプリに要求を送信できます。 その後、Calico pre-DNAT ポリシーを使用して、特定のソース IP アドレスや CIDR からのトラフィックのみをホワイトリスティングしたり、他のすべてのトラフィックのブロックしたりすることで、パブリック・ネットワーク・サービスへのトラフィックを制御できます。詳しくは、[パブリック外部ロード・バランシングの計画](/docs/containers?topic=containers-cs_network_planning#private_access)を参照してください。

セキュリティーを強化するために、ネットワーク・ワークロードをエッジ・ワーカー・ノードに分離します。エッジ・ワーカー・ノードを使用すると、外部的にアクセスされる、パブリック VLAN に接続されたワーカー・ノードの数を減らし、ネットワークのワークロードを分離することができるので、クラスターのセキュリティーが改善されます。[ワーカー・ノードにエッジ・ノードとしてラベルを付ける](/docs/containers?topic=containers-edge#edge_nodes)と、NLB ポッドと ALB ポッドは、指定されたワーカー・ノードにのみデプロイされます。他のワークロードをエッジ・ノードで実行しないようにするには、[エッジ・ノードにテイントを適用します](/docs/containers?topic=containers-edge#edge_workloads)。Kubernetes バージョン 1.14 以降では、パブリックとプライベートの両方の NLB および ALB をエッジ・ノードにデプロイできます。
例えば、ワーカー・ノードがプライベート VLAN にのみ接続されているが、クラスター内のアプリへのパブリック・アクセスを許可する必要がある場合、エッジ・ノードがパブリック VLAN およびプライベート VLAN に接続されるエッジ・ワーカー・プールを作成できます。パブリック NLB および ALB をこれらのエッジ・ノードにデプロイして、それらのワーカーのみがパブリック接続を処理するようにすることができます。

ワーカー・ノードがプライベート VLAN にのみ接続され、かつ、ゲートウェイ・デバイスを使用してワーカー・ノードとクラスター・マスターの間の通信を提供する場合は、デバイスをパブリック・ファイアウォールまたはプライベート・ファイアウォールとして構成することもできます。クラスター外部からアプリへのパブリック・トラフィック要求またはプライベート・トラフィック要求を許可するには、パブリックまたはプライベートの NodePort、NLB、および Ingress ALB を作成します。その後、パブリック・ネットワークまたはプライベート・ネットワークを介した、これらのサービスへのインバウンド・トラフィックを許可するために、ゲートウェイ・デバイス・ファイアウォールで[必要なポートおよび IP アドレスを開く](/docs/containers?topic=containers-firewall#firewall_inbound)必要があります。
{: note}

<br />


## シナリオ: クラスター内のインターネット向けアプリ・ワークロードの実行
{: #internet-facing}

このシナリオでは、エンド・ユーザーがアプリにアクセスできるように、インターネットからの要求にアクセス可能なワークロードをクラスター内で実行します。クラスター内のパブリック・アクセスを分離し、クラスターに対して許可されるパブリック要求を制御するオプションが必要です。さらに、ワーカーは、クラスターに接続するすべての {{site.data.keyword.Bluemix_notm}} サービスに自動的にアクセスできます。
{: shortdesc}

<p>
<figure>
 <img src="images/cs_clusters_planning_internet.png" alt="インターネット向けワークロードを実行するクラスターのアーキテクチャー・イメージ"/>
 <figcaption>インターネット向けワークロードを実行するクラスターのアーキテクチャー</figcaption>
</figure>
</p>

このセットアップを行うには、ワーカー・ノードをパブリック VLAN およびプライベート VLAN に接続して、クラスターを作成します。

パブリック VLAN とプライベート VLAN の両方に接続するクラスターを作成した場合に、後でそのクラスターからすべてのパブリック VLAN を削除することはできません。クラスターからすべてのパブリック VLAN を削除すると、複数のクラスター・コンポーネントが作業を停止します。 代わりに、プライベート VLAN のみに接続された新規ワーカー・プールを作成します。
{: note}

パブリック・ネットワークとプライベート・ネットワークを介して、またはパブリック・ネットワークのみを介して、ワーカーとマスターおよびユーザーとマスターの通信を許可できます。
* パブリック・サービス・エンドポイントおよびプライベート・サービス・エンドポイント: ご使用のアカウントで VRF を有効にし、サービス・エンドポイントを使用できるようにする必要があります。ワーカー・ノードとマスターの通信は、プライベート・サービス・エンドポイントを介するプライベート・ネットワークと、パブリック・サービス・エンドポイントを介するパブリック・ネットワークの両方を経由して確立されます。許可されたクラスター・ユーザーは、パブリック・サービス・エンドポイントを介してパブリックからマスターにアクセスできます。
* パブリック・サービス・エンドポイント: アカウントの VRF を有効にしない、または有効にできない場合、ワーカー・ノードおよび権限を持つクラスター・ユーザーは、パブリック・サービス・エンドポイントを介してパブリック・ネットワーク経由で自動的に Kubernetes マスターに接続できます。

ワーカー・ノードは、IBM Cloud インフラストラクチャー (SoftLayer) プライベート・ネットワークを介してプライベート・サービス・エンドポイントをサポートする他の {{site.data.keyword.Bluemix_notm}} サービスと自動的かつ安全に通信できます。{{site.data.keyword.Bluemix_notm}} サービスがプライベート・サービス・エンドポイントをサポートしていない場合、ワーカーはパブリック・ネットワークを介してサービスと安全に通信できます。パブリック・ネットワークまたはプライベート・ネットワークの分離に Calico ネットワーク・ポリシーを使用することで、ワーカー・ノードのパブリック・インターフェースまたはプライベート・インターフェースをロックダウンできます。これらの Calico 分離ポリシーで使用するサービスのパブリック IP アドレスおよびプライベート IP アドレスへのアクセスを許可することが必要な場合があります。

クラスター内のアプリをインターネットに公開するには、パブリック・ネットワーク・ロード・バランサー (NLB) または Ingress アプリケーション・ロード・バランサー (ALB) サービスを作成します。エッジ・ノードとしてラベル付けされたワーカー・ノードのプールを作成することにより、クラスターのセキュリティーを向上させることができます。パブリック・ネットワーク・サービスのポッドはエッジ・ノードにデプロイされるため、外部トラフィック・ワークロードはクラスター内の少数のワーカーにのみ分離されます。ホワイトリスト・ポリシーやブラックリスト・ポリシーなどの Calico pre-DNAT ポリシーを作成することで、アプリを公開するネットワーク・サービスへのパブリック・トラフィックをさらに制御できます。

ワーカー・ノードが {{site.data.keyword.Bluemix_notm}} アカウント外のプライベート・ネットワーク内のサービスにアクセスする必要がある場合は、クラスターで strongSwan IPSec VPN サービスを構成およびデプロイするか、{{site.data.keyword.Bluemix_notm}} {{site.data.keyword.Bluemix_notm}} Direct Link サービスを利用してこのようなネットワークに接続します。

このシナリオ用のクラスターを使用して始めましょう。[高可用性](/docs/containers?topic=containers-ha_clusters)および[ワーカー・ノード](/docs/containers?topic=containers-planning_worker_nodes)のセットアップを計画したら、[クラスターの作成](/docs/containers?topic=containers-clusters#cluster_prepare)を参照してください。

<br />


## シナリオ: オンプレミス・データ・センターをプライベート・ネットワーク上のクラスターに拡張し、限定パブリック・アクセスを追加する
{: #limited-public}

このシナリオでは、オンプレミス・データ・センター内のサービス、データベース、またはその他のリソースにアクセス可能なワークロードをクラスター内で実行します。ただし、クラスターへの限定パブリック・アクセスを提供する必要があり、パブリック・アクセスがクラスター内で制御および分離されるようにする場合があります。例えば、プライベート・サービス・エンドポイントをサポートせず、パブリック・ネットワークを介してアクセスする必要がある {{site.data.keyword.Bluemix_notm}} サービスに、ワーカーがアクセスすることが必要になる場合があります。あるいは、クラスター内で実行されるアプリへの限定パブリック・アクセスを提供する必要がある場合もあります。
{: shortdesc}

このクラスターのセットアップを実現するには、[エッジ・ノードと Calico ネットワーク・ポリシーを使用](#calico-pc)するか、[ゲートウェイ・デバイスを使用](#vyatta-gateway)して、ファイアウォールを作成します。

### エッジ・ノードおよび Calico ネットワーク・ポリシーの使用
{: #calico-pc}

エッジ・ノードをパブリック・ゲートウェイとして使用し、Calico ネットワーク・ポリシーをパブリック・ファイアウォールとして使用して、クラスターへの限定パブリック接続を許可します。
{: shortdesc}

<p>
<figure>
 <img src="images/cs_clusters_planning_calico.png" alt="安全なパブリック・アクセスのためにエッジ・ノードと Calico ネットワーク・ポリシーを使用するクラスターのアーキテクチャー・イメージ"/>
 <figcaption>安全なパブリック・アクセスのためにエッジ・ノードと Calico ネットワーク・ポリシーを使用するクラスターのアーキテクチャー</figcaption>
</figure>
</p>

このセットアップでは、ワーカー・ノードをプライベート VLAN のみに接続してクラスターを作成します。ご使用のアカウントで VRF を有効にし、プライベート・サービス・エンドポイントを使用できるようにする必要があります。

許可されたクラスター・ユーザーは、{{site.data.keyword.Bluemix_notm}} プライベート・ネットワークの中で作業している場合、または [VPN 接続](/docs/infrastructure/iaas-vpn?topic=VPN-gettingstarted-with-virtual-private-networking)や [{{site.data.keyword.Bluemix_notm}} Direct Link](/docs/infrastructure/direct-link?topic=direct-link-get-started-with-ibm-cloud-direct-link) 経由でプライベート・ネットワークに接続している場合に、プライベート・サービス・エンドポイントを介して、Kubernetes マスターにアクセスできます。 ただし、プライベート・サービス・エンドポイントを介した Kubernetes マスターとの通信は、<code>166.X.X.X</code> IP アドレス範囲を経由する必要があり、これは VPN 接続から、および {{site.data.keyword.Bluemix_notm}} Direct Link を介してルーティング可能ではありません。プライベート・ネットワーク・ロード・バランサー (NLB) を使用して、クラスター・ユーザーのマスターのプライベート・サービス・エンドポイントを公開できます。プライベート NLB は、ユーザーが VPN または {{site.data.keyword.Bluemix_notm}} Direct Link 接続を使用してアクセスできる内部 <code>10.X.X.X</code> IP アドレス範囲として、マスターのプライベート・サービス・エンドポイントを公開します。プライベート・サービス・エンドポイントのみを有効にする場合は、Kubernetes ダッシュボードを使用するか、パブリック・サービス・エンドポイントを一時的に有効にして、プライベート NLB を作成できます。

次に、パブリック VLAN およびプライベート VLAN に接続され、エッジ・ノードとしてラベル付けされるワーカー・ノードのプールを作成できます。エッジ・ノードを使用すると、外部的にアクセスされるワーカー・ノードの数を減らし、ネットワークのワークロードをワーカーに分離することができるので、クラスターのセキュリティーが改善されます。

ワーカー・ノードは、IBM Cloud インフラストラクチャー (SoftLayer) プライベート・ネットワークを介してプライベート・サービス・エンドポイントをサポートする他の {{site.data.keyword.Bluemix_notm}} サービスと自動的かつ安全に通信できます。{{site.data.keyword.Bluemix_notm}} サービスがプライベート・サービス・エンドポイントをサポートしていない場合、パブリック VLAN に接続されたエッジ・ノードはパブリック・ネットワークを介してサービスと安全に通信できます。パブリック・ネットワークまたはプライベート・ネットワークの分離に Calico ネットワーク・ポリシーを使用することで、ワーカー・ノードのパブリック・インターフェースまたはプライベート・インターフェースをロックダウンできます。これらの Calico 分離ポリシーで使用するサービスのパブリック IP アドレスおよびプライベート IP アドレスへのアクセスを許可することが必要な場合があります。

クラスター内のアプリへのプライベート・アクセスを提供するには、プライベート・ネットワーク・ロード・バランサー (NLB) または Ingress アプリケーション・ロード・バランサー (ALB) を作成して、アプリをプライベート・ネットワークにのみ公開します。ワーカー・ノード上のパブリック NodePort をブロックするポリシーなどの Calico pre-DNAT ポリシーを作成することで、アプリを公開するこれらのネットワーク・サービスへのすべてのパブリック・トラフィックをブロックできます。クラスター内のアプリへの限定パブリック・アクセスを提供する必要がある場合は、パブリック NLB または ALB を作成してアプリを公開できます。その後、NLB または ALB がパブリック・トラフィックをアプリ・ポッドに送信できるように、これらのエッジ・ノードにアプリをデプロイする必要があります。ホワイトリスト・ポリシーやブラックリスト・ポリシーなどの Calico pre-DNAT ポリシーを作成することで、アプリを公開するネットワーク・サービスへのパブリック・トラフィックをさらに制御できます。プライベート・ネットワーク・サービスとパブリック・ネットワーク・サービスの両方のポッドがエッジ・ノードにデプロイされるため、外部トラフィック・ワークロードはクラスター内の少数のワーカーのみに制限されます。  

{{site.data.keyword.Bluemix_notm}} およびその他のオンプレミス・ネットワークの外部にあるサービスに安全にアクセスするには、クラスターで strongSwan IPSec VPN サービスをクラスターを構成およびデプロイします。strongSwan ロード・バランサー・ポッドは、エッジ・プール内のワーカーにデプロイされ、ポッドはパブリック・ネットワークを介して暗号化された VPN トンネルを経由してオンプレミス・ネットワークへのセキュアな接続を確立します。あるいは、{{site.data.keyword.Bluemix_notm}} Direct Link サービスを使用して、プライベート・ネットワークのみを介して、クラスターをオンプレミス・データ・センターに接続することもできます。

このシナリオ用のクラスターを使用して始めましょう。[高可用性](/docs/containers?topic=containers-ha_clusters)および[ワーカー・ノード](/docs/containers?topic=containers-planning_worker_nodes)のセットアップを計画したら、[クラスターの作成](/docs/containers?topic=containers-clusters#cluster_prepare)を参照してください。

</br>

### ゲートウェイ・デバイスの使用
{: #vyatta-gateway}

Virtual Router Appliance (Vyatta) などのゲートウェイ・デバイスをパブリック・ゲートウェイおよびファイアウォールとして構成することにより、クラスターへの限定パブリック接続を許可します。
{: shortdesc}

<p>
<figure>
 <img src="images/cs_clusters_planning_gateway.png" alt="セキュアなパブリック・アクセスのためにゲートウェイ・デバイスを使用するクラスターのアーキテクチャー・イメージ"/>
 <figcaption>セキュアなパブリック・アクセスのためにゲートウェイ・デバイスを使用するクラスターのアーキテクチャー</figcaption>
</figure>
</p>

ワーカー・ノードをプライベート VLAN 上でのみセットアップし、ご使用のアカウントで VRF を有効にしないか、有効にできない場合は、パブリック・ネットワークを介してワーカー・ノードとマスターの間のネットワーク接続を提供するようにゲートウェイ・デバイスを構成する必要があります。例えば、[Virtual Router Appliance](/docs/infrastructure/virtual-router-appliance?topic=virtual-router-appliance-about-the-vra) または [Fortigate Security Appliance](/docs/services/vmwaresolutions/services?topic=vmware-solutions-fsa_considerations) をセットアップできます。

カスタム・ネットワーク・ポリシーをゲートウェイ・デバイスにセットアップして、クラスターのための専用ネットワーク・セキュリティーを設定し、ネットワーク侵入を検出して対処できます。パブリック・ネットワークでファイアウォールをセットアップする場合は、マスターとワーカー・ノードが通信できるように、地域ごとに必要なポートとプライベート IP アドレスを開く必要があります。プライベート・ネットワークにもこのファイアウォールを構成する場合も、ワーカー・ノード間の通信を許可し、クラスターがプライベート・ネットワークを介してインフラストラクチャー・リソースにアクセスできるように、必要なポートとプライベート IP アドレスを開く必要があります。サブネットが同じ VLAN 上および複数の VLAN 間で経路指定できるように、アカウントの VLAN スパンニングを有効にする必要もあります。

ワーカー・ノードとアプリを {{site.data.keyword.Bluemix_notm}} 外部の外部のオンプレミス・ネットワークまたはサービスに安全に接続するには、ゲートウェイ VPN エンドポイントを使用するように、ゲートウェイ・デバイス上に IPSec VPN エンドポイントをセットアップし、クラスター内の strongSwan IPSec VPN サービスをセットアップします。strongSwan を使用しない場合は、VRA を使用して、直接、VPN 接続をセットアップできます。

ワーカー・ノードは、ゲートウェイ・デバイスを介して {{site.data.keyword.Bluemix_notm}} 外部の他の {{site.data.keyword.Bluemix_notm}} サービスおよびパブリック・サービスと安全に通信できます。使用するサービスのみのパブリック IP アドレスおよびプライベート IP アドレスにアクセスできるようにファイアウォールを構成できます。

クラスター内のアプリへのプライベート・アクセスを提供するには、プライベート・ネットワーク・ロード・バランサー (NLB) または Ingress アプリケーション・ロード・バランサー (ALB) を作成して、アプリをプライベート・ネットワークにのみ公開します。クラスター内のアプリへの限定パブリック・アクセスを提供する必要がある場合は、パブリック NLB または ALB を作成してアプリを公開できます。すべてのトラフィックがゲートウェイ・デバイス・ファイアウォールを通過するため、ファイアウォールでサービスのポートと IP アドレスを開き、これらのサービスへのインバウンド・トラフィックを許可することで、アプリを公開するネットワーク・サービスへのパブリック・トラフィックを制御できます。

このシナリオ用のクラスターを使用して始めましょう。[高可用性](/docs/containers?topic=containers-ha_clusters)および[ワーカー・ノード](/docs/containers?topic=containers-planning_worker_nodes)のセットアップを計画したら、[クラスターの作成](/docs/containers?topic=containers-clusters#cluster_prepare)を参照してください。

<br />


## シナリオ: オンプレミス・データ・センターをプライベート・ネットワーク上のクラスターに拡張する
{: #private_clusters}

このシナリオでは、{{site.data.keyword.containerlong_notm}} クラスターでワークロードを実行します。ただし、このワークロードが、{{site.data.keyword.icpfull_notm}} などのオンプレミス・データ・センター内のサービス、データベース、またはその他のリソースのみにアクセスできるようにする必要があります。クラスター・ワークロードは、{{site.data.keyword.cos_full_notm}} などのプライベート・ネットワークを介した通信をサポートする他のいくつかの {{site.data.keyword.Bluemix_notm}} サービスにアクセスする必要がある場合があります。
{: shortdesc}

<p>
<figure>
 <img src="images/cs_clusters_planning_extend.png" alt="プライベート・ネットワークのオンプレミス・データ・センターに接続するクラスターのアーキテクチャー・イメージ"/>
 <figcaption>プライベート・ネットワークのオンプレミス・データ・センターに接続するクラスターのアーキテクチャー</figcaption>
</figure>
</p>

このセットアップを行うには、ワーカー・ノードをプライベート VLAN のみに接続してクラスターを作成します。プライベート・サービス・エンドポイントのみを介してプライベート・ネットワークを経由してクラスター・マスターとワーカー・ノードの間の接続を提供するには、ご使用のアカウントで VRF を有効にし、サービス・エンドポイントを使用できるようにする必要があります。VRF が有効な場合、クラスターはプライベート・ネットワーク上のすべてのリソースから可視であるため、Calico プライベート・ネットワーク・ポリシーを適用することで、プライベート・ネットワーク上の他のシステムからクラスターを分離できます。

許可されたクラスター・ユーザーは、{{site.data.keyword.Bluemix_notm}} プライベート・ネットワークの中で作業している場合、または [VPN 接続](/docs/infrastructure/iaas-vpn?topic=VPN-gettingstarted-with-virtual-private-networking)や [{{site.data.keyword.Bluemix_notm}} Direct Link](/docs/infrastructure/direct-link?topic=direct-link-get-started-with-ibm-cloud-direct-link) 経由でプライベート・ネットワークに接続している場合に、プライベート・サービス・エンドポイントを介して、Kubernetes マスターにアクセスできます。 ただし、プライベート・サービス・エンドポイントを介した Kubernetes マスターとの通信は、<code>166.X.X.X</code> IP アドレス範囲を経由する必要があり、これは VPN 接続から、および {{site.data.keyword.Bluemix_notm}} Direct Link を介してルーティング可能ではありません。プライベート・ネットワーク・ロード・バランサー (NLB) を使用して、クラスター・ユーザーのマスターのプライベート・サービス・エンドポイントを公開できます。プライベート NLB は、ユーザーが VPN または {{site.data.keyword.Bluemix_notm}} Direct Link 接続を使用してアクセスできる内部 <code>10.X.X.X</code> IP アドレス範囲として、マスターのプライベート・サービス・エンドポイントを公開します。プライベート・サービス・エンドポイントのみを有効にする場合は、Kubernetes ダッシュボードを使用するか、パブリック・サービス・エンドポイントを一時的に有効にして、プライベート NLB を作成できます。

ワーカー・ノードは、IBM Cloud インフラストラクチャー (SoftLayer) プライベート・ネットワークを介して、{{site.data.keyword.registrylong}} などのプライベート・サービス・エンドポイントをサポートする他の {{site.data.keyword.Bluemix_notm}} サービスと自動的かつ安全に通信できます。例えば、{{site.data.keyword.cloudant_short_notm}} のすべての標準プラン・インスタンスの専用ハードウェア環境は、プライベート・サービス・エンドポイントをサポートします。{{site.data.keyword.Bluemix_notm}} サービスがプライベート・サービス・エンドポイントをサポートしていない場合、クラスターはそのサービスにアクセスできません。

クラスター内のアプリへのプライベート・アクセスを提供するには、プライベート・ネットワーク・ロード・バランサー (NLB) または Ingress アプリケーション・ロード・バランサー (ALB) を作成します。これらの Kubernetes ネットワーク・サービスは、NLB IP があるサブネットへの接続を持つオンプレミス・システムがアプリにアクセスできるように、アプリをプライベート・ネットワークのみに公開します。

このシナリオ用のクラスターを使用して始めましょう。[高可用性](/docs/containers?topic=containers-ha_clusters)および[ワーカー・ノード](/docs/containers?topic=containers-planning_worker_nodes)のセットアップを計画したら、[クラスターの作成](/docs/containers?topic=containers-clusters#cluster_prepare)を参照してください。
